# Plan 단계 독립 WIP

## 기본 정보
- **WorkID**: WIP-20260225-001
- **스테이지**: Plan
- **담당 에이전트**: analyst
- **생성일**: 2026-02-25
- **상태**: 완료

---

## 🔒 절대 규칙 준수 확인 (강제)

> **강제 체크**: 이 체크박스를 모두 체크해야만 작업 완료로 간주됩니다.

### analyst 절대 규칙 체크
- [x] 무조건 캐스팅 (Type)cast 남용하지 않음
- [x] 불필요한 dynamic 사용하지 않음
- [x] 빈 catch 블록이 없음
- [x] IsBusy 상태가 try-finally로 보장됨
- [x] 빈 catch 블록 없음
- [x] 테스트 삭제하지 않음
- [x] 커밋 없이 파일 수정하지 않음 (사용자 요청 전)
- [x] 단언 없이 추측하지 않음
- [x] 개발 파이프라인 지침을 파괴하지 않음
- [x] 모든 위반이 없음을 확인함

---

## 지시 정보

### 작업 대상 (Target)
- FEATURE_BACKLOG.md의 **2번 기능: 스키마 생성 시 헤더 체크 박스 (선택적 포함/제외)** 구현

### 변경 파일 (Files)
- `Models/SchemaDefinition.cs` (수정)
- `ViewModels/SchemaEditorViewModel.cs` (수정)
- `Views/SchemaEditorView.xaml` (수정)
- `Services/ExportService.cs` (수정)
- `Services/CodeGeneratorService.cs` (수정)
- `Services/Processors/StaticDataProcessor.cs` (수정)
- `Services/SchemaGeneratorService.cs` (수정)

### 필수 조건 (Requirements)
- 체크 해제된 헤더 → 데이터 추출 및 코드 생성에서 제외
- Key 컬럼으로 지정된 헤더 → 체크 여부 무관 무조건 포함 (체크박스 비활성화)
- 기존 스키마 파일과의 하위 호환성 유지

### 사전 결정 사항 (사용자 확정)
1. **저장 방식**: `ExcludedFields` 배열 (별도 `"excludedFields": [...]` 속성 추가)
2. **Key 컬럼 표시**: 잠금 아이콘 + 체크 (🔒 아이콘 + 비활성화된 체크박스)
3. **하위 호환**: ExcludedFields 없는 기존 스키마 로드 시 전부 포함으로 처리

---

## 작업 진행 내용

### 1단계: 확인 및 분석 (Confirm & Analyze)
- [x] 지시 내용 확인
- [x] 관련 파일 목록 파악
- [x] 기존 코드/문서 분석
- [x] 유형 판단 (신규)
- [x] 영향 범위 분석

### 2단계: 계획 (Plan)
- [x] 작업 계획 수립
- [x] 예상 변경 파일 정리
- [x] 위험 요소 식별
- [x] 사용자 확인 요청 준비

### 3단계: 실행 (Execute)
- [x] 계획 문서화
- [x] **수렴 분석**: 계획 결과물에 대한 보완 사항 도출
- [x] 보완 사항 분류 (필수/선택) 및 필수 보완 사항 반영
- [x] 수렴 확인: 필수 보완 사항 0건 달성
- [x] 잔존 선택 보완 사항 목록 기록
- [x] 사용자 확인 요청
- [x] 사용자 응답 기록: 승인 (2026-02-25)
- [x] Gate 준비

---

## 분석 결과

### 유형 판단
- **유형**: 신규 (기존 스키마 편집기에 새 기능 추가)
- **근거**: 기존에 필드 제외 관련 코드가 전혀 없음. 모델 확장, UI 변경, 처리 파이프라인 필터링 추가 필요.

### 영향 분석

#### 신규 파일
| 파일 | 역할 |
|------|------|
| `Converters/InverseBooleanConverter.cs` | IValueConverter: bool → !bool 변환 (Key 컬럼 체크박스 비활성화용) |

#### 수정 파일
| 파일 | 변경 내용 |
|------|----------|
| `Models/SchemaDefinition.cs` | `ExcludedFields` (List<string>) 속성 추가 |
| `ViewModels/SchemaEditorViewModel.cs` | `SchemaFieldViewModel`에 IsIncluded, IsKeyColumn 추가; Save()에 ExcludedFields 저장; 로드 시 복원; SelectedKey 변경 연동 |
| `Views/SchemaEditorView.xaml` | 체크박스 열 + 잠금 아이콘 추가 |
| `App.xaml` | InverseBooleanConverter 글로벌 리소스 등록 |
| `Services/ExportService.cs` | ExportToBinary/ExportToJson에서 ExcludedFields 필터링 |
| `Services/CodeGeneratorService.cs` | PrepareDataContext에서 ExcludedFields 필터링 |
| `Services/Processors/StaticDataProcessor.cs` | 스키마 로드 후 ExcludedFields 기반 필터링 |
| `Services/SchemaGeneratorService.cs` | 자동 생성 시 ExcludedFields = 빈 리스트 (전부 포함 기본값) |

- **위험도**: 중간

### 상세 계획

#### Phase 1: 모델 확장

**Models/SchemaDefinition.cs**
```csharp
[JsonProperty("excludedFields")]
public List<string> ExcludedFields { get; set; } = new List<string>();
```
- 기존 스키마 JSON 로드 시 `excludedFields` 키가 없으면 빈 리스트 → 전부 포함 (하위 호환)

#### Phase 2: ViewModel 확장

**SchemaFieldViewModel 추가 속성**
```csharp
public bool IsIncluded { get; set; }  // true = 포함, false = 제외
public bool IsKeyColumn { get; set; } // true = Key 컬럼 (비활성화)
```

**SchemaEditorItemViewModel 변경**
- 생성자: existingSchema 로드 시 `ExcludedFields`에 포함된 필드 → `IsIncluded = false`
- 생성자: `SelectedKey`와 동일한 HeaderName → `IsKeyColumn = true`, `IsIncluded = true`
- `SelectedKey` setter: 이전 Key의 IsKeyColumn 해제, 새 Key의 IsKeyColumn 설정 + IsIncluded 강제 true
- `Save()`: `IsIncluded == false`인 필드의 HeaderName을 ExcludedFields에 추가

#### Phase 3: UI 변경

**Converters/InverseBooleanConverter.cs (신규)**
- `IValueConverter` 구현: `true` → `false`, `false` → `true`
- Key 컬럼 체크박스의 `IsEnabled` 바인딩에 사용

**App.xaml (수정)**
- `InverseBooleanConverter` 글로벌 리소스 등록

**SchemaEditorView.xaml**
- Field Configurations 그리드에 체크박스 열(60px) 추가 (첫 번째 열)
- CheckBox: `IsChecked="{Binding IsIncluded}"`, `IsEnabled="{Binding IsKeyColumn, Converter={StaticResource InverseBooleanConverter}}"`
- Key 컬럼: 체크박스 옆에 🔒 텍스트 표시 (TextBlock, `Visibility="{Binding IsKeyColumn, Converter={StaticResource BooleanToVisibilityConverter}}"`)
- 헤더 라벨 행에 "Include" 텍스트 추가
- 기존 3열 → 4열 구조로 변경 (Include / Excel Header / Data Type / Reference)

#### Phase 4: 처리 파이프라인 반영

**ExportService.cs**
- `ExportToBinary()`, `ExportToJson()`: `schema.Fields`를 순회하기 전에 `schema.ExcludedFields`에 포함된 키를 건너뛰기
- 구현: `schema.Fields.Where(f => !schema.ExcludedFields.Contains(f.Key))`

**CodeGeneratorService.cs**
- `PrepareDataContext()`: `schema.Fields.Select()` → ExcludedFields 필터링 추가

**StaticDataProcessor.cs**
- 스키마 역직렬화 후 별도 필터링 불필요 (ExportService/CodeGeneratorService에서 처리)

**SchemaGeneratorService.cs**
- 자동 생성 시 `ExcludedFields = new List<string>()` (기본값 유지, 변경 불필요)

### 위험 요소
| 위험 | 대응 |
|------|------|
| 기존 스키마 JSON에 excludedFields 없음 | Newtonsoft.Json 기본 동작: 없으면 빈 리스트 유지 (하위 호환) |
| Key 컬럼이 ExcludedFields에 포함된 채 저장 | Save() 시 Key 컬럼은 ExcludedFields에서 강제 제거 |
| List 타입 (동일 헤더명 복수) 제외 | 동일 HeaderName은 하나의 필드로 그룹핑되어 있으므로 문제 없음 |
| Reference 타입이 제외된 필드를 참조 | 현재 Reference는 문자열이므로 런타임 오류 없음 (경고 표시는 향후 확장) |
| Binary 포맷 호환성 | ExcludedFields가 변경되면 바이너리 구조 변경 → 사용자가 인지해야 함 (기존 동작과 동일) |

### 수렴 분석

#### 수렴 반복 #1
- **발견된 보완 사항**: 4건 (필수 2건 / 선택 2건)
- **필수 보완 사항**:
  1. `InverseBooleanConverter` 미존재: Key 컬럼 체크박스 비활성화를 위해 IsKeyColumn → !IsKeyColumn 변환 필요. 프로젝트에 없으므로 신규 추가 필요 → 영향 파일에 `Converters/InverseBooleanConverter.cs` (신규), `App.xaml` (수정) 추가
  2. `SelectedKey` 변경 시 IsKeyColumn 전파 로직 누락: 현재 setter는 단순 SetProperty만 호출. Key 변경 시 이전 Key 필드의 IsKeyColumn 해제, 새 Key 필드의 IsKeyColumn 설정 + IsIncluded 강제 true 로직 필요 → Phase 2 상세 계획에 반영
- **선택 보완 사항**:
  1. "전체 선택/해제" 토글: 편의 기능이나 필수는 아님 → 향후 확장
  2. Reference 충돌 경고: 제외된 필드가 다른 필드의 Reference로 참조 시 경고 → 향후 확장
- **결과**: 필수 보완 사항 반영 완료 (영향 파일 목록에 Converter 추가, Phase 2 계획 보강)

#### 수렴 반복 #2
- **발견된 보완 사항**: 0건 (필수 0건 / 선택 0건)
- **결과**: 수렴 달성

---

## 진척도
- **진척도**: 100%

---

## 크로스체크 결과

### architect 크로스체크 (Gate-1)
- [x] 1차 검증 통과: Plan 완전성 PASS
- [x] 2차 검증 통과: 아키텍처 정합성 CONDITIONAL PASS (Design 확인 사항 3건)
- [x] 크로스체크 통과: PASS with Design Review Notes
- 상태: 통과 (2026-02-25)
- Design 확인 사항:
  1. SchemaFieldViewModel의 IsIncluded/IsKeyColumn에 JsonIgnore 필요 여부
  2. XAML 그리드 헤더/ItemTemplate Grid.Column 인덱싱 동기화
  3. SelectedKey Setter의 Fields 순회 로직 이벤트 순서
