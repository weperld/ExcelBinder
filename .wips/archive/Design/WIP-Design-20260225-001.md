# Design ë‹¨ê³„ ë…ë¦½ WIP

## ê¸°ë³¸ ì •ë³´
- **WorkID**: WIP-20260225-001
- **ìŠ¤í…Œì´ì§€**: Design
- **ë‹´ë‹¹ ì—ì´ì „íŠ¸**: architect
- **ìƒì„±ì¼**: 2026-02-25
- **ìƒíƒœ**: ì™„ë£Œ

---

## ğŸ”’ ì ˆëŒ€ ê·œì¹™ ì¤€ìˆ˜ í™•ì¸ (ê°•ì œ)

### architect ì ˆëŒ€ ê·œì¹™ ì²´í¬
- [x] ë¬´ì¡°ê±´ ìºìŠ¤íŒ… (Type)cast ë‚¨ìš©í•˜ì§€ ì•ŠìŒ
- [x] ë¶ˆí•„ìš”í•œ dynamic ì‚¬ìš©í•˜ì§€ ì•ŠìŒ
- [x] ë¹ˆ catch ë¸”ë¡ì´ ì—†ìŒ
- [x] IsBusy ìƒíƒœê°€ try-finallyë¡œ ë³´ì¥ë¨
- [x] ë¹ˆ catch ë¸”ë¡ ì—†ìŒ
- [x] í…ŒìŠ¤íŠ¸ ì‚­ì œí•˜ì§€ ì•ŠìŒ
- [x] ì»¤ë°‹ ì—†ì´ íŒŒì¼ ìˆ˜ì •í•˜ì§€ ì•ŠìŒ (ì‚¬ìš©ì ìš”ì²­ ì „)
- [x] ë‹¨ì–¸ ì—†ì´ ì¶”ì¸¡í•˜ì§€ ì•ŠìŒ
- [x] ê°œë°œ íŒŒì´í”„ë¼ì¸ ì§€ì¹¨ì„ íŒŒê´´í•˜ì§€ ì•ŠìŒ
- [x] ëª¨ë“  ìœ„ë°˜ì´ ì—†ìŒì„ í™•ì¸í•¨

---

## ì§€ì‹œ ì •ë³´

### ì‘ì—… ëŒ€ìƒ (Target)
- WIP-20260225-001 Plan ê²°ê³¼ ê¸°ë°˜ ìƒì„¸ ì„¤ê³„
- ìŠ¤í‚¤ë§ˆ í—¤ë” ì²´í¬ ë°•ìŠ¤ (ì„ íƒì  í¬í•¨/ì œì™¸) ê¸°ëŠ¥

### ë³€ê²½ íŒŒì¼ (Files)
- `Converters/InverseBooleanConverter.cs` (ì‹ ê·œ)
- `Models/SchemaDefinition.cs` (ìˆ˜ì •)
- `ViewModels/SchemaEditorViewModel.cs` (ìˆ˜ì •)
- `Views/SchemaEditorView.xaml` (ìˆ˜ì •)
- `App.xaml` (ìˆ˜ì •)
- `Services/ExportService.cs` (ìˆ˜ì •)
- `Services/CodeGeneratorService.cs` (ìˆ˜ì •)

### í•„ìˆ˜ ì¡°ê±´ (Requirements)
- Gate-1 Design Review Notes ë°˜ì˜:
  1. SchemaFieldViewModelì˜ IsIncluded/IsKeyColumn â†’ ViewModel ì „ìš© ì†ì„± (JSON ì§ë ¬í™” ë¬´ê´€)
  2. XAML ê·¸ë¦¬ë“œ í—¤ë”/ItemTemplate Column ì¸ë±ì‹± ë™ê¸°í™”
  3. SelectedKey Setterì˜ Fields ìˆœíšŒ ë¡œì§

---

## ì‘ì—… ì§„í–‰ ë‚´ìš©

### 1ë‹¨ê³„: í™•ì¸ ë° ë¶„ì„ (Confirm & Analyze)
- [x] ê³„íš ë¬¸ì„œ í™•ì¸
- [x] ê¸°ì¡´ ì•„í‚¤í…ì²˜ ë¶„ì„
- [x] ê¸°ìˆ ì  ì œì•½ì‚¬í•­ íŒŒì•…

### 2ë‹¨ê³„: ê³„íš (Plan)
- [x] ì•„í‚¤í…ì²˜ ì„¤ê³„
- [x] ì¸í„°í˜ì´ìŠ¤ ì •ì˜
- [x] ê¸°ìˆ ì  ê²€ì¦

### 3ë‹¨ê³„: ì‹¤í–‰ (Execute)
- [x] ì„¤ê³„ ë¬¸ì„œ ì‘ì„±
- [x] **ìˆ˜ë ´ ë¶„ì„**: ì„¤ê³„ ê²°ê³¼ë¬¼ì— ëŒ€í•œ ë³´ì™„ ì‚¬í•­ ë„ì¶œ
- [x] ë³´ì™„ ì‚¬í•­ ë¶„ë¥˜ (í•„ìˆ˜/ì„ íƒ) ë° í•„ìˆ˜ ë³´ì™„ ì‚¬í•­ ë°˜ì˜
- [x] ìˆ˜ë ´ í™•ì¸: í•„ìˆ˜ ë³´ì™„ ì‚¬í•­ 0ê±´ ë‹¬ì„±
- [x] ì”ì¡´ ì„ íƒ ë³´ì™„ ì‚¬í•­ ëª©ë¡ ê¸°ë¡
- [x] ì„¤ê³„ ë¦¬ë·° ì¤€ë¹„
- [x] Gate ì¤€ë¹„: ì‚¬ìš©ì ìŠ¹ì¸ (2026-02-25)

---

## ì„¤ê³„ ê²°ê³¼

### ì•„í‚¤í…ì²˜ ë‹¤ì´ì–´ê·¸ë¨

```
[SchemaEditorView.xaml]
    â”œâ”€ CheckBox â”€â”€ IsIncluded (ë°”ì¸ë”©)
    â”œâ”€ ğŸ”’ Icon â”€â”€ IsKeyColumn â†’ BooleanToVisibilityConverter
    â””â”€ IsEnabled â”€â”€ IsKeyColumn â†’ InverseBooleanConverter

[SchemaEditorItemViewModel]
    â”œâ”€ Fields: ObservableCollection<SchemaFieldViewModel>
    â”œâ”€ SelectedKey setter â†’ UpdateKeyColumnStatus()
    â””â”€ Save() â†’ ExcludedFields ìƒì„±

[SchemaDefinition] â”€â”€â”€ JSON ì§ë ¬í™” â”€â”€â”€â†’ Schema.json
    â”œâ”€ Fields: Dictionary<string, string>
    â””â”€ ExcludedFields: List<string>  â† ì‹ ê·œ

[ExportService / CodeGeneratorService]
    â””â”€ schema.Fields ìˆœíšŒ ì‹œ ExcludedFields í•„í„°ë§
```

### í´ë˜ìŠ¤/ì¸í„°í˜ì´ìŠ¤ êµ¬ì¡°

#### 1. Models/SchemaDefinition.cs

```csharp
public class SchemaDefinition
{
    [JsonProperty("className")]
    public string ClassName { get; set; } = string.Empty;

    [JsonProperty("key")]
    public string Key { get; set; } = ProjectConstants.Excel.DefaultSheetKey;

    [JsonProperty("fields")]
    public Dictionary<string, string> Fields { get; set; } = new Dictionary<string, string>();

    // ì‹ ê·œ ì¶”ê°€
    [JsonProperty("excludedFields")]
    public List<string> ExcludedFields { get; set; } = new List<string>();
}
```

**ì„¤ê³„ ê²°ì •**: `ExcludedFields`ì˜ ê¸°ë³¸ê°’ì€ `new List<string>()`ìœ¼ë¡œ ì´ˆê¸°í™”. Newtonsoft.Json ì—­ì§ë ¬í™” ì‹œ JSONì— `excludedFields` í‚¤ê°€ ì—†ìœ¼ë©´ ì´ˆê¸°ê°’ì´ ìœ ì§€ë˜ë¯€ë¡œ í•˜ìœ„ í˜¸í™˜ì„± ë³´ì¥.

#### 2. ViewModels/SchemaFieldViewModel

```csharp
public class SchemaFieldViewModel : ViewModelBase
{
    public string HeaderName { get; set; } = string.Empty;
    public int Count { get; set; } = 1;
    public string DisplayName => Count > 1 ? $"{HeaderName}({Count})" : HeaderName;

    private string _selectedType = ProjectConstants.Types.Int;
    private string _referenceType = string.Empty;
    private bool _isIncluded = true;      // ì‹ ê·œ
    private bool _isKeyColumn;            // ì‹ ê·œ

    public string SelectedType
    {
        get => _selectedType;
        set => SetProperty(ref _selectedType, value);
    }

    public string ReferenceType
    {
        get => _referenceType;
        set => SetProperty(ref _referenceType, value);
    }

    // ì‹ ê·œ: í¬í•¨ ì—¬ë¶€ (true = ë‚´ë³´ë‚´ê¸°/ì½”ë“œìƒì„±ì— í¬í•¨)
    public bool IsIncluded
    {
        get => _isIncluded;
        set => SetProperty(ref _isIncluded, value);
    }

    // ì‹ ê·œ: Key ì»¬ëŸ¼ ì—¬ë¶€ (true = ì²´í¬ë°•ìŠ¤ ë¹„í™œì„±í™” + ì ê¸ˆ ì•„ì´ì½˜)
    public bool IsKeyColumn
    {
        get => _isKeyColumn;
        set => SetProperty(ref _isKeyColumn, value);
    }
}
```

**ì„¤ê³„ ê²°ì •**: `IsIncluded`ì™€ `IsKeyColumn`ì€ ViewModel ì „ìš© ì†ì„±. `SchemaFieldViewModel`ì€ JSONìœ¼ë¡œ ì§ë ¬í™”ë˜ì§€ ì•ŠìŒ (`SchemaDefinition`ë§Œ ì§ë ¬í™”). ë”°ë¼ì„œ `[JsonIgnore]` ë¶ˆí•„ìš”.

#### 3. ViewModels/SchemaEditorItemViewModel

**ìƒì„±ì ë³€ê²½ (ê¸°ì¡´ ìŠ¤í‚¤ë§ˆ ë¡œë“œ ë¶€ë¶„)**:
```csharp
// existingSchema ë¡œë“œ í›„, Fields ìƒì„± ì‹œ
Fields.Add(new SchemaFieldViewModel
{
    HeaderName = group.Name,
    Count = group.Count,
    SelectedType = selectedType,
    ReferenceType = referenceType,
    IsIncluded = existingSchema == null || !existingSchema.ExcludedFields.Contains(group.Name)
});

// Key ì»¬ëŸ¼ ì„¤ì •
foreach (var field in Fields)
{
    field.IsKeyColumn = (field.HeaderName == _selectedKey);
}
```

**SelectedKey setter ë³€ê²½**:
```csharp
public string SelectedKey
{
    get => _selectedKey;
    set
    {
        if (!SetProperty(ref _selectedKey, value)) return;
        UpdateKeyColumnStatus();
    }
}

private void UpdateKeyColumnStatus()
{
    foreach (var field in Fields)
    {
        bool isKey = field.HeaderName == _selectedKey;
        field.IsKeyColumn = isKey;
        if (isKey)
        {
            field.IsIncluded = true; // Key ì»¬ëŸ¼ì€ í•­ìƒ í¬í•¨
        }
    }
}
```

**Save() ë³€ê²½**:
```csharp
public void Save()
{
    var schema = new SchemaDefinition
    {
        ClassName = _sheetName + "Data",
        Key = SelectedKey,
        Fields = new Dictionary<string, string>(),
        ExcludedFields = new List<string>()
    };

    foreach (var field in Fields)
    {
        // ëª¨ë“  í•„ë“œì˜ íƒ€ì… ì •ë³´ëŠ” í•­ìƒ ì €ì¥ (ì œì™¸ í•„ë“œë„ íƒ€ì… ë³´ì¡´)
        string typeStr = field.SelectedType;
        if (!string.IsNullOrWhiteSpace(field.ReferenceType))
        {
            typeStr = $"{typeStr}:ref:{field.ReferenceType}";
        }
        if (field.Count > 1)
        {
            typeStr = $"List<{typeStr}>";
        }
        schema.Fields[field.HeaderName] = typeStr;

        // ì œì™¸ í•„ë“œ ê¸°ë¡ (Key ì»¬ëŸ¼ì€ ê°•ì œ ì œì™¸ ë°©ì§€)
        if (!field.IsIncluded && field.HeaderName != SelectedKey)
        {
            schema.ExcludedFields.Add(field.HeaderName);
        }
    }

    if (!Directory.Exists(_outputPath)) Directory.CreateDirectory(_outputPath);
    string finalFileName = $"{_fileName}_{_sheetName}_Schema.json";
    string savePath = Path.Combine(_outputPath, finalFileName);
    File.WriteAllText(savePath, JsonConvert.SerializeObject(schema, Formatting.Indented));
}
```

**í•µì‹¬ ì„¤ê³„ ê²°ì •**: ì œì™¸ëœ í•„ë“œë„ `Fields` ë”•ì…”ë„ˆë¦¬ì— íƒ€ì… ì •ë³´ë¥¼ ìœ ì§€. ì´ë ‡ê²Œ í•˜ë©´ ë‚˜ì¤‘ì— ë‹¤ì‹œ í¬í•¨í•  ë•Œ íƒ€ì…ì„ ë‹¤ì‹œ ì§€ì •í•  í•„ìš” ì—†ìŒ. `ExcludedFields`ëŠ” í•„í„°ë§ ëª©ì ìœ¼ë¡œë§Œ ì‚¬ìš©.

#### 4. Converters/InverseBooleanConverter.cs

```csharp
using System;
using System.Globalization;
using System.Windows.Data;

namespace ExcelBinder.Converters
{
    public class InverseBooleanConverter : IValueConverter
    {
        public object Convert(object value, Type targetType, object parameter, CultureInfo culture)
        {
            return value is bool b ? !b : value;
        }

        public object ConvertBack(object value, Type targetType, object parameter, CultureInfo culture)
        {
            return value is bool b ? !b : value;
        }
    }
}
```

#### 5. App.xaml ë¦¬ì†ŒìŠ¤ ë“±ë¡

```xml
<!-- ê¸°ì¡´ -->
<BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>

<!-- ì‹ ê·œ ì¶”ê°€ -->
<local:InverseBooleanConverter x:Key="InverseBooleanConverter"/>
```
- `xmlns:local`ì´ ì´ë¯¸ ìˆëŠ”ì§€ í™•ì¸ í•„ìš”. ì—†ìœ¼ë©´ `xmlns:converters="clr-namespace:ExcelBinder.Converters"` ì¶”ê°€.

#### 6. Views/SchemaEditorView.xaml

**í—¤ë” ë¼ë²¨ ê·¸ë¦¬ë“œ (Grid.Row="0")**:
```xml
<Grid Grid.Row="0" Margin="10,5,25,10">
    <Grid.ColumnDefinitions>
        <ColumnDefinition Width="60"/>   <!-- Include (ì‹ ê·œ) -->
        <ColumnDefinition Width="200"/>  <!-- Excel Header -->
        <ColumnDefinition Width="150"/>  <!-- Data Type -->
        <ColumnDefinition Width="*"/>    <!-- Reference -->
    </Grid.ColumnDefinitions>
    <TextBlock Text="Include" FontWeight="Bold" Foreground="{StaticResource MutedTextBrush}"/>
    <TextBlock Grid.Column="1" Text="Excel Header" FontWeight="Bold" Foreground="{StaticResource MutedTextBrush}"/>
    <TextBlock Grid.Column="2" Text="Data Type" FontWeight="Bold" Foreground="{StaticResource MutedTextBrush}"/>
    <StackPanel Grid.Column="3" Orientation="Horizontal">
        <TextBlock Text="Reference (Optional)" FontWeight="Bold" Foreground="{StaticResource MutedTextBrush}"/>
        <Button Style="{StaticResource HelpButtonStyle}" ToolTipService.ToolTip="{StaticResource ReferenceTypeHelp}"/>
    </StackPanel>
</Grid>
```

**ItemTemplate ê·¸ë¦¬ë“œ**:
```xml
<DataTemplate>
    <Border BorderBrush="{StaticResource BorderBrush}" BorderThickness="0,0,0,1" Padding="5,8">
        <Grid>
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="60"/>   <!-- Include (ì‹ ê·œ) -->
                <ColumnDefinition Width="200"/>  <!-- Excel Header -->
                <ColumnDefinition Width="150"/>  <!-- Data Type -->
                <ColumnDefinition Width="*"/>    <!-- Reference -->
            </Grid.ColumnDefinitions>

            <!-- ì‹ ê·œ: ì²´í¬ë°•ìŠ¤ + ì ê¸ˆ ì•„ì´ì½˜ -->
            <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                <CheckBox IsChecked="{Binding IsIncluded}"
                          IsEnabled="{Binding IsKeyColumn, Converter={StaticResource InverseBooleanConverter}}"
                          Margin="5,0"/>
                <TextBlock Text="ğŸ”’" FontSize="12"
                           Visibility="{Binding IsKeyColumn, Converter={StaticResource BooleanToVisibilityConverter}}"
                           VerticalAlignment="Center" Margin="2,0,0,0"/>
            </StackPanel>

            <!-- ê¸°ì¡´ (Grid.Column ì¸ë±ìŠ¤ +1) -->
            <TextBlock Grid.Column="1" Text="{Binding DisplayName}" VerticalAlignment="Center" FontWeight="SemiBold" Margin="5,0"/>
            <ComboBox Grid.Column="2" ItemsSource="{Binding DataContext.AvailableTypes, RelativeSource={RelativeSource AncestorType=ItemsControl}}"
                      SelectedItem="{Binding SelectedType}" Margin="5,0" Height="30"/>
            <TextBox Grid.Column="3" Text="{Binding ReferenceType, UpdateSourceTrigger=PropertyChanged}" Margin="5,0" Height="30"
                     Tag="Reference Type (Optional)"/>
        </Grid>
    </Border>
</DataTemplate>
```

#### 7. ExportService.cs í•„í„°ë§

**ExportToBinary / ExportToJson ê³µí†µ**: `schema.Fields` ìˆœíšŒ ë¶€ë¶„ì„ í•„í„°ë§:

```csharp
// ë³€ê²½ ì „
foreach (var field in schema.Fields)

// ë³€ê²½ í›„
var activeFields = schema.Fields
    .Where(f => !schema.ExcludedFields.Contains(f.Key));
foreach (var field in activeFields)
```

ë‘ ë©”ì„œë“œ ëª¨ë‘ ë™ì¼í•œ íŒ¨í„´ ì ìš©.

#### 8. CodeGeneratorService.cs í•„í„°ë§

**PrepareDataContext()**: `schema.Fields.Select()` ì•ì— í•„í„°ë§:

```csharp
// ë³€ê²½ ì „
var fields = schema.Fields.Select(f => { ... }).ToList();

// ë³€ê²½ í›„
var fields = schema.Fields
    .Where(f => !schema.ExcludedFields.Contains(f.Key))
    .Select(f => { ... }).ToList();
```

### ê¸°ìˆ ì  ê²°ì • ì‚¬í•­

| ê²°ì • | ê·¼ê±° |
|------|------|
| ExcludedFieldsëŠ” Fieldsì™€ ë³„ë„ ê´€ë¦¬ | ì œì™¸ í•„ë“œì˜ íƒ€ì… ì •ë³´ ë³´ì¡´ â†’ ì¬í¬í•¨ ì‹œ í¸ì˜ì„± |
| IsIncluded/IsKeyColumnì€ ViewModel ì „ìš© | SchemaFieldViewModelì€ JSON ì§ë ¬í™” ëŒ€ìƒ ì•„ë‹˜ â†’ JsonIgnore ë¶ˆí•„ìš” |
| UpdateKeyColumnStatus() ë©”ì„œë“œ ë¶„ë¦¬ | SelectedKey setterì™€ ìƒì„±ìì—ì„œ ì¬ì‚¬ìš© |
| í•„í„°ë§ì€ ExportService/CodeGenì—ì„œ ì²˜ë¦¬ | StaticDataProcessorëŠ” ìŠ¤í‚¤ë§ˆ ë¡œë“œë§Œ ë‹´ë‹¹ â†’ ë³„ë„ í•„í„°ë§ ë¶ˆí•„ìš” |
| App.xamlì— ì»¨ë²„í„° ê¸€ë¡œë²Œ ë“±ë¡ | í”„ë¡œì íŠ¸ ê¸°ì¡´ íŒ¨í„´ (BooleanToVisibilityConverter) ì¤€ìˆ˜ |
| Converters/ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ì‹ ê·œ ìƒì„± | ê¸°ì¡´ í”„ë¡œì íŠ¸ì— Converters í´ë” ì—†ìŒ â†’ ì‹ ê·œ ë””ë ‰í† ë¦¬ |
| App.xamlì— converters xmlns ì¶”ê°€ | `xmlns:converters="clr-namespace:ExcelBinder.Converters"` í•„ìš” |
| StaticDataProcessor ìˆ˜ì • ë¶ˆí•„ìš” | schemaë¥¼ ExportServiceì— ì „ë‹¬ë§Œ í•¨ â†’ í•„í„°ë§ì€ ExportServiceì—ì„œ ì²˜ë¦¬ |

### ìˆ˜ë ´ ë¶„ì„

#### ìˆ˜ë ´ ë°˜ë³µ #1
- **ë°œê²¬ëœ ë³´ì™„ ì‚¬í•­**: 1ê±´ (í•„ìˆ˜ 1ê±´ / ì„ íƒ 0ê±´)
- **í•„ìˆ˜ ë³´ì™„ ì‚¬í•­**:
  1. App.xamlì— `xmlns:converters` ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ì„ ì–¸ ëˆ„ë½ â†’ ì„¤ê³„ ë¬¸ì„œì— ë°˜ì˜ ì™„ë£Œ
- **ê²°ê³¼**: í•„ìˆ˜ ë³´ì™„ ì‚¬í•­ ë°˜ì˜ ì™„ë£Œ

#### ìˆ˜ë ´ ë°˜ë³µ #2
- **ë°œê²¬ëœ ë³´ì™„ ì‚¬í•­**: 0ê±´ (í•„ìˆ˜ 0ê±´ / ì„ íƒ 0ê±´)
- **ê²°ê³¼**: ìˆ˜ë ´ ë‹¬ì„±

---

## ì§„ì²™ë„
- **ì§„ì²™ë„**: 100%

---

## í¬ë¡œìŠ¤ì²´í¬ ê²°ê³¼

### developer í¬ë¡œìŠ¤ì²´í¬ (Gate-2)
- [ ] 1ì°¨ ê²€ì¦ í†µê³¼
- [ ] 2ì°¨ ê²€ì¦ í†µê³¼
- [ ] í¬ë¡œìŠ¤ì²´í¬ í†µê³¼
- ìƒíƒœ: ëŒ€ê¸° ì¤‘
